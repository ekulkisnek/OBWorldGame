<!DOCTYPE html>
<html>
<head>
    <title>Pokémon-Style Game</title>
    <style>
        /* ----------------------------------------------------------
           GAME CONTAINER & PLAYER
        ---------------------------------------------------------- */
        #game-container {
            width: 320px;
            height: 240px;
            background-image: url("{{ url_for('static', filename='assets/grass.svg') }}");
            background-size: 16px 16px;
            position: relative;
            overflow: hidden;
            border: 2px solid black;
            image-rendering: pixelated;
            background-color: #8bc34a; /* Fallback color */
        }

        /* The player’s sprite sheet is 4 frames across × 4 rows (64×64).
           Each frame is 16×16. */
        #player {
            width: 16px;
            height: 16px;
            position: absolute;
            background-image: url("{{ url_for('static', filename='assets/pokeguy.png') }}");
            background-size: 64px 64px; 
            background-repeat: no-repeat;
            z-index: 10;
        }

        /* ----------------------------------------------------------
           OBJECT TILES (HOUSE, TREES, ETC.)
           Adjust background-size to match your actual tiles.png dimension.
           Below we assume a ~192×192 overall sheet, each sprite carefully
           positioned. If they’re still cut off, tweak these numbers.
        ---------------------------------------------------------- */
        .tile {
            position: absolute;
            image-rendering: pixelated;
            background-image: url("{{ url_for('static', filename='assets/tiles.png') }}");
            background-size: 192px 192px; /* Adjust as needed for your tiles.png */
            background-repeat: no-repeat;
        }

        /* Example: a 3×3 tile house (48×48) in the top-left corner of tiles.png */
        .house {
            width: 48px;
            height: 48px;
            background-position: 0 0; /* Adjust if house is not at (0,0) in tiles.png */
        }

        /* Example: a big tree that’s 2×3 tiles (32×48),
           positioned at x=48 so it’s right next to the house, etc. */
        .tree {
            width: 32px;
            height: 48px;
            background-position: -48px 0; /* Adjust if needed */
        }

        /* Example: a 16×16 rock at x=80, y=0 in tiles.png */
        .rock {
            width: 16px;
            height: 16px;
            background-position: -80px 0;
        }

        /* Example: a small tree that’s 16×24, placed at x=96, y=0 */
        .small-tree {
            width: 16px;
            height: 24px;
            background-position: -96px 0;
        }

        /* Example: a 16×16 hay bale at x=112, y=0 */
        .hay {
            width: 16px;
            height: 16px;
            background-position: -112px 0;
        }

        /* Example: a 16×16 signpost at x=128, y=0 */
        .signpost {
            width: 16px;
            height: 16px;
            background-position: -128px 0;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="player"></div>
    </div>

    <script>
        /* ----------------------------------------------------------
           CONFIG CONSTANTS
        ---------------------------------------------------------- */
        const TILE_SIZE = 16;           // Each map tile is 16×16
        const MAP_WIDTH = 20;           // 20 tiles wide
        const MAP_HEIGHT = 15;          // 15 tiles tall
        const ANIMATION_FRAMES = 4;     // 4 walking frames per direction
        const ANIMATION_SPEED = 150;    // ms between animation frames

        /* ----------------------------------------------------------
           GAME CLASS
        ---------------------------------------------------------- */
        class Game {
            constructor() {
                // DOM references
                this.container = document.getElementById("game-container");
                this.player = document.getElementById("player");

                // Player starts at tile (9,7) => convert to pixel coords
                this.playerX = 9 * TILE_SIZE;
                this.playerY = 7 * TILE_SIZE;

                // Movement speed in pixels/frame (increase for faster walking)
                this.moveSpeed = 1.5;

                // Track arrow keys (up, down, left, right) 
                this.keys = { up: false, down: false, left: false, right: false };

                // Animation state
                this.facing = "down";
                this.currentFrame = 0;
                this.animationTimer = null;
                this.isMoving = false;

                // 2D map array
                this.map = [];
                this.initMap();
                this.updatePlayerPosition();
                this.setupControls();

                // Start the continuous loop for smooth movement
                requestAnimationFrame(() => this.gameLoop());
            }

            /* ------------------------------------------------------
               Initialize map array & place some objects
            ------------------------------------------------------ */
            initMap() {
                // Fill the map with zeros (walkable)
                for (let y = 0; y < MAP_HEIGHT; y++) {
                    this.map[y] = [];
                    for (let x = 0; x < MAP_WIDTH; x++) {
                        this.map[y][x] = 0;
                    }
                }

                // Place a house (3×3 tiles => 48×48), type=2 at tile (1,1)
                this.placeObject(1, 1, 3, 3, 2, "house");

                // Place big trees (2×3 tiles => 32×48), type=1
                this.placeObject(15, 1, 2, 3, 1, "tree");
                this.placeObject(15, 10, 2, 3, 1, "tree");

                // Place a rock (1×1 tile => 16×16), type=3
                this.placeObject(5, 10, 1, 1, 3, "rock");

                // Randomly place 3 small trees (1×2 tiles => 16×24), type=4
                for (let i = 0; i < 3; i++) {
                    let placed = false;
                    while (!placed) {
                        const rx = Math.floor(Math.random() * MAP_WIDTH);
                        const ry = Math.floor(Math.random() * MAP_HEIGHT);
                        if (this.canPlace(rx, ry, 1, 2) && (rx !== 9 || ry !== 7)) {
                            this.placeObject(rx, ry, 1, 2, 4, "small-tree");
                            placed = true;
                        }
                    }
                }

                // Randomly place 2 hay bales (1×1 tile => 16×16), type=5
                for (let i = 0; i < 2; i++) {
                    let placed = false;
                    while (!placed) {
                        const rx = Math.floor(Math.random() * MAP_WIDTH);
                        const ry = Math.floor(Math.random() * MAP_HEIGHT);
                        if (this.canPlace(rx, ry, 1, 1) && (rx !== 9 || ry !== 7)) {
                            this.placeObject(rx, ry, 1, 1, 5, "hay");
                            placed = true;
                        }
                    }
                }

                // Place a signpost (1×1), type=6
                this.placeObject(10, 5, 1, 1, 6, "signpost");
            }

            /* ------------------------------------------------------
               Check if we can place an object of size w×h at tile (x,y)
            ------------------------------------------------------ */
            canPlace(x, y, width, height) {
                for (let dy = 0; dy < height; dy++) {
                    for (let dx = 0; dx < width; dx++) {
                        const checkX = x + dx;
                        const checkY = y + dy;
                        if (
                            checkX < 0 || checkX >= MAP_WIDTH ||
                            checkY < 0 || checkY >= MAP_HEIGHT ||
                            this.map[checkY][checkX] !== 0
                        ) {
                            return false;
                        }
                    }
                }
                return true;
            }

            /* ------------------------------------------------------
               Create an HTML element for the placed object, and mark
               those tiles in the map array with its “type”
            ------------------------------------------------------ */
            placeObject(x, y, width, height, type, className) {
                for (let dy = 0; dy < height; dy++) {
                    for (let dx = 0; dx < width; dx++) {
                        this.map[y + dy][x + dx] = type;
                    }
                }
                const obj = document.createElement("div");
                obj.className = `tile ${className}`;
                obj.style.left = (x * TILE_SIZE) + "px";
                obj.style.top = (y * TILE_SIZE) + "px";
                this.container.appendChild(obj);
            }

            /* ------------------------------------------------------
               Collision check for smooth (pixel-based) movement
               We check the 4 corners of the 16×16 player sprite.
            ------------------------------------------------------ */
            canMovePixel(px, py) {
                const playerSize = 16; // Player is 16×16
                const corners = [
                    { x: px, y: py },
                    { x: px + playerSize - 1, y: py },
                    { x: px, y: py + playerSize - 1 },
                    { x: px + playerSize - 1, y: py + playerSize - 1 }
                ];
                for (let c of corners) {
                    const tileX = Math.floor(c.x / TILE_SIZE);
                    const tileY = Math.floor(c.y / TILE_SIZE);
                    if (
                        tileX < 0 || tileX >= MAP_WIDTH ||
                        tileY < 0 || tileY >= MAP_HEIGHT ||
                        this.map[tileY][tileX] !== 0
                    ) {
                        return false;
                    }
                }
                return true;
            }

            /* ------------------------------------------------------
               Setup arrow key listeners
            ------------------------------------------------------ */
            setupControls() {
                document.addEventListener("keydown", (event) => {
                    switch (event.key) {
                        case "ArrowUp":
                            event.preventDefault();
                            this.keys.up = true;
                            break;
                        case "ArrowDown":
                            event.preventDefault();
                            this.keys.down = true;
                            break;
                        case "ArrowLeft":
                            event.preventDefault();
                            this.keys.left = true;
                            break;
                        case "ArrowRight":
                            event.preventDefault();
                            this.keys.right = true;
                            break;
                    }
                });

                document.addEventListener("keyup", (event) => {
                    switch (event.key) {
                        case "ArrowUp":
                            this.keys.up = false;
                            break;
                        case "ArrowDown":
                            this.keys.down = false;
                            break;
                        case "ArrowLeft":
                            this.keys.left = false;
                            break;
                        case "ArrowRight":
                            this.keys.right = false;
                            break;
                    }
                });
            }

            /* ------------------------------------------------------
               Main loop using requestAnimationFrame for smooth movement
            ------------------------------------------------------ */
            gameLoop() {
                let dx = 0;
                let dy = 0;
                this.isMoving = false;

                // Decide direction based on which keys are held
                if (this.keys.up) {
                    dy -= this.moveSpeed;
                    this.facing = "up";
                    this.isMoving = true;
                }
                if (this.keys.down) {
                    dy += this.moveSpeed;
                    this.facing = "down";
                    this.isMoving = true;
                }
                if (this.keys.left) {
                    dx -= this.moveSpeed;
                    this.facing = "left";
                    this.isMoving = true;
                }
                if (this.keys.right) {
                    dx += this.moveSpeed;
                    this.facing = "right";
                    this.isMoving = true;
                }

                // Move along X if no collision
                const newX = this.playerX + dx;
                if (this.canMovePixel(newX, this.playerY)) {
                    this.playerX = newX;
                }

                // Move along Y if no collision
                const newY = this.playerY + dy;
                if (this.canMovePixel(this.playerX, newY)) {
                    this.playerY = newY;
                }

                // Update only the player's DOM position (no animation update here)
                this.updatePlayerPosition();

                // **NEW CODE**: If the player is moving and no animation is active,
                // start the animation update (which runs on its own timer)
                if (this.isMoving && !this.animationTimer) {
                    this.updateAnimation();
                }

                // Continue the loop
                requestAnimationFrame(() => this.gameLoop());
            }

            /* ------------------------------------------------------
               Update player’s DOM position (in pixels)
            ------------------------------------------------------ */
            updatePlayerDOMPosition() {
                this.player.style.left = this.playerX + "px";
                this.player.style.top = this.playerY + "px";
            }

            /* ------------------------------------------------------
               Update player’s position
            ------------------------------------------------------ */
            updatePlayerPosition() {
                this.updatePlayerDOMPosition();
            }

            /* ------------------------------------------------------
               Handle walking animation frames
            ------------------------------------------------------ */
            updateAnimation() {
                // Each direction corresponds to a row in the sprite sheet
                const row = {
                    down: 0,
                    left: 1,
                    right: 2,
                    up: 3,
                }[this.facing];

                // Cycle through frames if moving; otherwise, set to frame 0
                const frameX = this.isMoving ? (this.currentFrame % ANIMATION_FRAMES) * 16 : 0;
                const frameY = row * 16;
                this.player.style.backgroundPosition = `-${frameX}px -${frameY}px`;

                // Clear any existing timer
                if (this.animationTimer) {
                    clearTimeout(this.animationTimer);
                    this.animationTimer = null;
                }

                // If still walking, advance frames on a timer
                if (this.isMoving) {
                    this.currentFrame = (this.currentFrame + 1) % ANIMATION_FRAMES;
                    this.animationTimer = setTimeout(() => {
                        this.updateAnimation();
                    }, ANIMATION_SPEED);
                }
                // If stopped and frame isn't zero, reset it
                else if (this.currentFrame !== 0) {
                    this.currentFrame = 0;
                    this.updateAnimation();
                }
            }
        }

        /* ----------------------------------------------------------
           LAUNCH GAME
        ---------------------------------------------------------- */
        window.addEventListener('load', () => {
            new Game();
        });
    </script>
</body>
</html>
